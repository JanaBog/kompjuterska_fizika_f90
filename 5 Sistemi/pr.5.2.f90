! ============================================================
!  Програм: gauss_pivot.f90
!  Цел: Решавање на систем A*x = b со метод на
!       Гаусова елиминација со парцијално пивотирање.
! ============================================================

program gauss_pivot
    implicit none
    integer, parameter :: n = 3
    real(8) :: A(n,n), b(n), x(n)
    real(8) :: factor, pivot_max
    integer :: i, j, k, p          ! p ќе биде индекс на редот со најголем pivot
    real(8) :: temp                ! за замена при пивотирање

    ! ------------------------------------------------------------
    ! Пример систем (истиот како претходно)
    ! ------------------------------------------------------------
    A = reshape([ 2.0d0,  1.0d0, -1.0d0, &
                 -3.0d0, -1.0d0,  2.0d0, &
                 -2.0d0,  1.0d0,  2.0d0 ], shape(A))
    b = [ 8.0d0, -11.0d0, -3.0d0 ]

    print *, "--------------------------------------------"
    print *, "Почетна матрица [A|b]:"
    do i = 1, n
        print '(3f10.3,2x,f10.3)', A(i,1:n), b(i)
    end do

    ! ============================================================
    ! ФАЗА 1: ПАРЦИЈАЛНО ПИВОТИРАЊЕ + ЕЛИМИНАЦИЈА
    ! ============================================================

    do k = 1, n-1
        ! --------------------------------------------------------
        ! 1. Најди ред (p) со најголем апсолутен елемент под pivot
        ! --------------------------------------------------------
        p = k
        pivot_max = abs(A(k,k))
        do i = k+1, n
            if (abs(A(i,k)) > pivot_max) then
                pivot_max = abs(A(i,k))
                p = i
            end if
        end do

        ! --------------------------------------------------------
        ! 2. Ако треба, замени ги редовите k и p (A и b)
        ! --------------------------------------------------------
        if (p /= k) then
            print *
            print *, "==> Се врши замена на редови ", k, " и ", p
            do j = k, n
                temp = A(k,j)
                A(k,j) = A(p,j)
                A(p,j) = temp
            end do
            temp = b(k)
            b(k) = b(p)
            b(p) = temp
        end if

        ! --------------------------------------------------------
        ! 3. Продолжи со елиминација под pivot
        ! --------------------------------------------------------
        if (A(k,k) == 0.0d0) then
            print *, "Nula pivot, ne moze da se prodolzi."
            stop
        end if

        do i = k+1, n
            factor = A(i,k) / A(k,k)
            do j = k, n
                A(i,j) = A(i,j) - factor * A(k,j)
            end do
            b(i) = b(i) - factor * b(k)
        end do

        ! --------------------------------------------------------
        ! 4. Печати состојбата по секоја колона
        ! --------------------------------------------------------
        print *
        print *, "Po obrabotka na kolonata", k
        do i = 1, n
            print '(3f10.3,2x,f10.3)', A(i,1:n), b(i)
        end do
    end do

    ! ============================================================
    ! ФАЗА 2: ЗАМЕНА НАНАЗАД
    ! ============================================================

    x(n) = b(n) / A(n,n)
    do i = n-1, 1, -1
        x(i) = b(i)
        do j = i+1, n
            x(i) = x(i) - A(i,j)*x(j)
        end do
        x(i) = x(i) / A(i,i)
    end do

    ! ============================================================
    ! ИЗЛЕЗ
    ! ============================================================
    print *
    print *, "--------------------------------------------"
    print *, "Resenieto e:"
    do i = 1, n
        print '(a,i1,a,f10.4)', "x(", i, ") = ", x(i)
    end do
    print *, "--------------------------------------------"

end program gauss_pivot

! ============================================================
!  Програм: lu_factorization.f90
!  Цел: LU факторизација и решавање на систем A*x = b
!       со долна и горна тријаголна матрица.
! ============================================================

program lu_factorization
    implicit none
    integer, parameter :: n = 3
    real(8) :: A(n,n), L(n,n), U(n,n)
    real(8) :: b(n), y(n), x(n)
    real(8) :: sum
    integer :: i, j, k, p

    ! ------------------------------------------------------------
    ! Влезни податоци (истиот систем)
    ! ------------------------------------------------------------
    A = reshape([ 2.0d0,  1.0d0, -1.0d0, &
                 -3.0d0, -1.0d0,  2.0d0, &
                 -2.0d0,  1.0d0,  2.0d0 ], shape(A))
    b = [ 8.0d0, -11.0d0, -3.0d0 ]

    ! ------------------------------------------------------------
    ! Инициализација: L = 0, U = 0
    ! ------------------------------------------------------------
    L = 0.0d0
    U = 0.0d0

    ! ============================================================
    ! ФАЗА 1: LU ФАКТОРИЗАЦИЈА
    ! ============================================================
    ! Алгоритам на Doolittle: L има 1 по дијагоналата.
    ! ============================================================

    do i = 1, n
        L(i,i) = 1.0d0   ! дијагоналата на L е 1
    end do

    do k = 1, n
        ! --- пресметај ги елементите на U (ред k)
        do j = k, n
            sum = 0.0d0
            do p = 1, k-1
                sum = sum + L(k,p) * U(p,j)
            end do
            U(k,j) = A(k,j) - sum
        end do

        ! --- пресметај ги елементите на L (колона k)
        do i = k+1, n
            sum = 0.0d0
            do p = 1, k-1
                sum = sum + L(i,p) * U(p,k)
            end do
            L(i,k) = (A(i,k) - sum) / U(k,k)
        end do
    end do

    ! Печатење на резултатите
    print *, "--------------------------------------"
    print *, "Matrica L:"
    do i = 1, n
        print '(3f10.3)', L(i,1:n)
    end do
    print *, "Matrica U:"
    do i = 1, n
        print '(3f10.3)', U(i,1:n)
    end do

    ! ============================================================
    ! ФАЗА 2: Решавање на L*y = b (замена нанапред)
    ! ============================================================
    do i = 1, n
        y(i) = b(i)
        do j = 1, i-1
            y(i) = y(i) - L(i,j)*y(j)
        end do
        y(i) = y(i)/L(i,i)
    end do

    ! ============================================================
    ! ФАЗА 3: Решавање на U*x = y (замена наназад)
    ! ============================================================
    do i = n, 1, -1
        x(i) = y(i)
        do j = i+1, n
            x(i) = x(i) - U(i,j)*x(j)
        end do
        x(i) = x(i)/U(i,i)
    end do

    ! ============================================================
    ! РЕЗУЛТАТ
    ! ============================================================
    print *, "--------------------------------------"
    print *, "Resenieto na sistemot e:"
    do i = 1, n
        print '(a,i1,a,f10.4)', "x(", i, ") = ", x(i)
    end do

end program lu_factorization
